.. module:: aiven_monitor.writer

writer
======

This module collects Measure generated by the aiven-monitor
checker into a Kafka topic and records them in a Postgres database.

This can be run as ``aiven-monitor-writer`` or ``python -m aiven_monitor.writer`` :

.. code-block:: text

    usage: aiven-monitor-writer [-h] [--config CONFIG]

    Collects measures generated by aiven-monitor-checker into a Kafka topic and records them in a Postgres database.

    optional arguments:
      -h, --help       show this help message and exit
      --config CONFIG  path to the config file. absolute or relative to the current working directory. defaults to "writer.ini".

Configuration Options
---------------------

The configuration options are read from a **writer.ini** file using :class:`ConfigParser`.

All the following settings must be in a **[writer]** section of the ini file.

.. code-block:: ini

    [writer]
    # A comma-separated list of Kafka servers. Will connect to "localhost:9092" if not configured.
    kafka.bootstrap_servers = "ocalhost:9092
    # Kafka topic receiving the produced Measure objects. Default value is "aiven_monitor_measure".
    kafka.topic = aiven_monitor_measure
    # Path to the PEM certificate of the authority used to authenticate the Kafka servers. Optional.
    kafka.ssl.cafile = /path/to/kafka.ca.pem
    # Path to the PEM certificate used to authenticate the checker. Optional.
    kafka.ssl.certfile = /path/to/kafka.certificate.pem
    # Path to the PEM private key used to authenticate the checker. Optional.
    kafka.ssl.keyfile = /path/to/kafka.private.pem
    # Number of seconds before retrying to connect. Default value is 1.0.
    kafka.connect_interval_secs = 1.0

    # Name of the table where measures are stored. Default value is "aiven_monitor_measure".
    postgres.measure_table = aiven_monitor_measure
    # Hostname of the Postgres server. Will connect to UNIX socket if not provided.
    postgres.host = localhost
    # Port of the Postgres server. Will connect through port 5432 if not provided and not a UNIX socket.
    postgres.port = 5432
    # Database inside the Postgres server. Will use to the same as the user name if not provided.
    postgres.database = postgres
    # User name to connect to the Postgres server.
    # Will use the same as the operating system name of the user running the application.
    postgres.user = postgres
    # Path to a text file with the password to connect to the Postgres server. Optional.
    postgres.passwordfile = /path/to/postgres.password
    # Path to the PEM certificate of the authority used to authenticate the Postgres server. Optional.
    postgres.ssl.rootcertfile = /path/to/postgres.ca.pem
    # Number of seconds before retrying to connect to Postgres. Default value is 1.0.
    postgres.connect_interval_secs = 1.0


Entry Points
------------

.. autofunction:: aiven_monitor.writer.main

.. autofunction:: aiven_monitor.writer.async_main

KafkaSource
------------------

.. autoclass:: aiven_monitor.writer.KafkaSource
    :members:

PostgresRecorder
----------------

.. autoclass:: aiven_monitor.writer.PostgresRecorder
    :members:
