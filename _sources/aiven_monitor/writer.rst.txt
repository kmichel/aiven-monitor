.. module:: aiven_monitor.writer

writer
======

This module collects Measure generated by the aiven-monitor
reader into a Kafka topic and records them in a Postgres database.

In addition to the classes documented below, this can be called from the
command line as `aiven-monitor-writer` or `python -m aiven_monitor.writer`.

Configuration Options
---------------------

The configuration options are read from `/run/secrets/writer.ini` using :class:`ConfigParser`.

All the following settings must be in a **[writer]** section of the ini file.

- **kafka.bootstrap_servers**: A comma-separated list of Kafka servers. Will connect to "localhost:9092" if not configured.
- **kafka.topic**: The Kafka topic from where :class:`aiven_monitor.Measure` objects will be consumed. Default value is "aiven_monitor_measure".
- **kafka.ssl.cafile**: The path to the PEM certificate of the certificate authority used to authenticate the Kafka servers. Optional.
- **kafka.ssl.certfile**: The path to the PEM certificate used to authenticate the writer. Optional.
- **kafka.ssl.keyfile**: The path to the PEM private key used to authenticate the writer. Optional.
- **kafka.connect_interval_secs**: The number of seconds before retrying to connect to Kafka. Default value is `1.0`.
- **postgres.measure_table**: The name of the table where measures are stored. Default value is "aiven_monitor_measure".
- **postgres.host**: The hostname of the Postgres server. Will connect to UNIX socket if not provided.
- **postgres.port**: The hostname of the Postgres server. Will connect through port 5432 if not provided and not a UNIX socket.
- **postgres.database**: The database inside the Postgres server. Will use to the same as the user name if not provided.
- **postgres.user**: The user name to connect to the Postgres server. Will use the same as the operating system name of the user running the application.
- **postgres.passwordfile**: The path to a text file with the password to connect to the Postgres server. Optional.
- **postgres.ssl.rootcertfile**: The path to the PEM certificate of the certificate authority used to authenticate the Postgres server. Optional.
- **postgres.connect_interval_secs**: The number of seconds before retrying to connect to Postgres. Default value is `1.0`.

Entry Points
------------

.. autofunction:: aiven_monitor.writer.main

.. autofunction:: aiven_monitor.writer.async_main

KafkaSource
------------------

.. autoclass:: aiven_monitor.writer.KafkaSource
    :members:

PostgresRecorder
----------------

.. autoclass:: aiven_monitor.writer.PostgresRecorder
    :members:
